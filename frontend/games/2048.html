<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>2048 - Gamyverse</title>
    <link rel="stylesheet" href="../css/style.css" />
    <link rel="stylesheet" href="../css/components/header.css" />
    <link rel="stylesheet" href="../css/components/footer.css" />
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
      .game-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
      }

      .game-header {
        width: 100%;
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
      }

      .game-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }

      .game-stats {
        display: flex;
        justify-content: space-between;
        width: 100%;
        max-width: 400px;
        margin-bottom: 20px;
      }

      .game-stat {
        background-color: rgba(10, 25, 41, 0.7);
        padding: 10px 20px;
        border-radius: 5px;
        text-align: center;
      }

      .grid-container {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        grid-template-rows: repeat(4, 1fr);
        gap: 10px;
        width: 100%;
        max-width: 400px;
        aspect-ratio: 1 / 1;
        padding: 10px;
        background-color: rgba(10, 25, 41, 0.7);
        border-radius: 5px;
      }

      .grid-cell {
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #1a2a3a;
        border-radius: 5px;
        font-size: 2rem;
        font-weight: bold;
        transition: all 0.2s;
      }

      .grid-cell.empty {
        background-color: #1a2a3a;
      }

      .grid-cell.tile-2 {
        background-color: #eee4da;
        color: #776e65;
      }

      .grid-cell.tile-4 {
        background-color: #ede0c8;
        color: #776e65;
      }

      .grid-cell.tile-8 {
        background-color: #f2b179;
        color: #f9f6f2;
      }

      .grid-cell.tile-16 {
        background-color: #f59563;
        color: #f9f6f2;
      }

      .grid-cell.tile-32 {
        background-color: #f67c5f;
        color: #f9f6f2;
      }

      .grid-cell.tile-64 {
        background-color: #f65e3b;
        color: #f9f6f2;
      }

      .grid-cell.tile-128 {
        background-color: #edcf72;
        color: #f9f6f2;
        font-size: 1.8rem;
      }

      .grid-cell.tile-256 {
        background-color: #edcc61;
        color: #f9f6f2;
        font-size: 1.8rem;
      }

      .grid-cell.tile-512 {
        background-color: #edc850;
        color: #f9f6f2;
        font-size: 1.8rem;
      }

      .grid-cell.tile-1024 {
        background-color: #edc53f;
        color: #f9f6f2;
        font-size: 1.4rem;
      }

      .grid-cell.tile-2048 {
        background-color: #edc22e;
        color: #f9f6f2;
        font-size: 1.4rem;
      }

      .game-over-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(10, 25, 41, 0.8);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        border-radius: 5px;
        z-index: 10;
        display: none;
      }

      .game-over-overlay h2 {
        color: #fff;
        font-size: 2rem;
        margin-bottom: 10px;
      }

      .game-over-overlay p {
        color: #fff;
        font-size: 1.2rem;
        margin-bottom: 20px;
      }

      .leaderboard {
        margin-top: 30px;
        width: 100%;
        max-width: 500px;
      }

      .leaderboard table {
        width: 100%;
        border-collapse: collapse;
      }

      .leaderboard th,
      .leaderboard td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #2a3e5c;
      }

      .leaderboard th {
        background-color: #0a1929;
        color: #4e7ac7;
      }

      .game-instructions {
        margin-top: 20px;
        background-color: rgba(10, 25, 41, 0.7);
        padding: 15px;
        border-radius: 5px;
        max-width: 500px;
      }

      .game-instructions h3 {
        margin-top: 0;
      }

      .grid-wrapper {
        position: relative;
        width: 100%;
        max-width: 400px;
      }
    </style>
  </head>
  <body>
    <div class="gradient-background">
      <header class="header">
        <div class="logo">
          <a href="../dashboard.html">
            <img src="../assets/logo.png" alt="Gamyverse Logo" />
            <span>Gamyverse</span>
          </a>
        </div>
      </header>

      <!-- Game Container -->
      <div class="game-container">
        <a href="../dashboard.html" class="back-to-dashboard">
          Back to Dashboard
        </a>
        <h1 class="game-title">2048</h1>

        <div class="game-controls">
          <button id="new-game-btn" class="btn btn-primary">New Game</button>
          <button id="save-score-btn" class="btn btn-secondary" disabled>
            Save Score
          </button>
          <button id="show-leaderboard-btn" class="btn btn-secondary">
            Show Leaderboard
          </button>
        </div>

        <div class="game-stats">
          <div class="game-stat">
            <h3>Score</h3>
            <p id="score-display">0</p>
          </div>
          <div class="game-stat">
            <h3>High Score</h3>
            <p id="high-score-display">0</p>
          </div>
        </div>

        <div class="grid-wrapper">
          <div class="grid-container" id="grid-container">
            <!-- Grid cells will be created dynamically -->
          </div>
          <div class="game-over-overlay" id="game-over-overlay">
            <h2>Game Over!</h2>
            <p>Your score: <span id="final-score">0</span></p>
            <button id="restart-btn" class="btn btn-primary">Play Again</button>
            <p
              style="font-size: 14px; margin-top: 10px; color: #ffa500"
              class="reminder-message"
            >
              Don't forget to save your score before clicking Play Again!
            </p>
          </div>
        </div>

        <div class="game-instructions">
          <h3>How to Play:</h3>
          <p>
            Use the arrow keys to move the tiles. When two tiles with the same
            number touch, they merge into one. Try to reach the 2048 tile!
          </p>
          <p>
            <strong>Controls:</strong> Arrow keys (↑ ↓ ← →) or swipe on mobile.
          </p>
        </div>

        <div class="leaderboard" id="leaderboard" style="display: none">
          <h2>Leaderboard</h2>
          <table>
            <thead>
              <tr>
                <th>Rank</th>
                <th>Player</th>
                <th>Score</th>
              </tr>
            </thead>
            <tbody id="leaderboard-body">
              <!-- Leaderboard entries will be inserted here -->
            </tbody>
          </table>
        </div>
      </div>

      <footer class="footer">
        <div class="footer-content">
          <div class="footer-logo-title">
            <span>Gamyverse</span>
            <p class="footer-tagline">An Ultimate Gaming Universe</p>
          </div>
          <div class="footer-social">
            <a href="mailto:snehaagarwal1322@gmail.com" aria-label="Gmail">
              <i data-feather="mail"></i>
            </a>
            <a
              href="https://www.linkedin.com/in/snehaagarwal03"
              aria-label="LinkedIn"
              target="_blank"
            >
              <i data-feather="linkedin"></i>
            </a>
            <a
              href="https://github.com/snehaagarwal03"
              aria-label="GitHub"
              target="_blank"
            >
              <i data-feather="github"></i>
            </a>
          </div>
        </div>
        <div class="footer-bottom">
          <p>&copy; 2025 Gamyverse. All rights reserved.</p>
        </div>
      </footer>
    </div>

    <script src="../js/auth.js"></script>
    <script src="../js/games.js"></script>
    <script src="../js/leaderboard.js"></script>
    <script>
      // Initialize Feather icon
      document.addEventListener("DOMContentLoaded", () => {
        feather.replace();

        // Check if user is logged in
        checkAuthStatus();

        // Update high score display
        updateHighScore();

        // Initialize game
        initializeGame();
      });

      // Game variables
      let grid = [];
      let score = 0;
      let gameOver = false;
      let gameWon = false;
      let hasChanged = false;

      // DOM elements
      const gridContainer = document.getElementById("grid-container");
      const newGameBtn = document.getElementById("new-game-btn");
      const saveScoreBtn = document.getElementById("save-score-btn");
      const showLeaderboardBtn = document.getElementById(
        "show-leaderboard-btn"
      );
      const scoreDisplay = document.getElementById("score-display");
      const highScoreDisplay = document.getElementById("high-score-display");
      const gameOverOverlay = document.getElementById("game-over-overlay");
      const finalScoreDisplay = document.getElementById("final-score");
      const restartBtn = document.getElementById("restart-btn");
      const leaderboardDiv = document.getElementById("leaderboard");

      // Event listeners
      newGameBtn.addEventListener("click", resetGame);
      saveScoreBtn.addEventListener("click", saveScore);
      showLeaderboardBtn.addEventListener("click", toggleLeaderboard);
      restartBtn.addEventListener("click", resetGame);

      // Keyboard event listener
      document.addEventListener("keydown", handleKeyPress);

      // Initialize game
      function initializeGame() {
        // Create grid cells
        createGrid();

        // Start a new game
        resetGame();
      }

      // Create the grid
      function createGrid() {
        gridContainer.innerHTML = "";

        for (let row = 0; row < 4; row++) {
          for (let col = 0; col < 4; col++) {
            const cell = document.createElement("div");
            cell.className = "grid-cell empty";
            cell.id = `cell-${row}-${col}`;
            gridContainer.appendChild(cell);
          }
        }
      }

      // Reset game
      function resetGame() {
        // Initialize empty grid
        grid = Array(4)
          .fill()
          .map(() => Array(4).fill(0));

        // Reset score
        score = 0;
        scoreDisplay.textContent = score;

        // Reset game state
        gameOver = false;
        gameWon = false;

        // Hide game over overlay
        gameOverOverlay.style.display = "none";

        // Disable save score button
        saveScoreBtn.disabled = true;

        // Clear all cells
        clearCells();

        // Add two initial tiles
        addRandomTile();
        addRandomTile();
      }

      // Clear all cells
      function clearCells() {
        const cells = document.querySelectorAll(".grid-cell");
        cells.forEach((cell) => {
          cell.className = "grid-cell empty";
          cell.textContent = "";
        });
      }

      // Add a random tile to the grid
      function addRandomTile() {
        // Find all empty cells
        const emptyCells = [];
        for (let row = 0; row < 4; row++) {
          for (let col = 0; col < 4; col++) {
            if (grid[row][col] === 0) {
              emptyCells.push({ row, col });
            }
          }
        }

        // If no empty cells, return
        if (emptyCells.length === 0) return;

        // Choose a random empty cell
        const randomCell =
          emptyCells[Math.floor(Math.random() * emptyCells.length)];

        // Place a 2 or 4 in the cell (90% chance of 2, 10% chance of 4)
        const value = Math.random() < 0.9 ? 2 : 4;
        grid[randomCell.row][randomCell.col] = value;

        // Update UI
        updateCellUI(randomCell.row, randomCell.col, value);
      }

      // Update cell UI
      function updateCellUI(row, col, value) {
        const cell = document.getElementById(`cell-${row}-${col}`);

        // Clear existing classes
        cell.className = "grid-cell";

        if (value === 0) {
          cell.className = "grid-cell empty";
          cell.textContent = "";
        } else {
          cell.className = `grid-cell tile-${value}`;
          cell.textContent = value;
        }
      }

      // Handle key press
      function handleKeyPress(e) {
        if (gameOver) return;

        let moved = false;

        switch (e.key) {
          case "ArrowUp":
            moved = moveUp();
            break;
          case "ArrowDown":
            moved = moveDown();
            break;
          case "ArrowLeft":
            moved = moveLeft();
            break;
          case "ArrowRight":
            moved = moveRight();
            break;
          default:
            return; // Ignore other keys
        }

        if (moved) {
          // Add a new tile after a valid move
          addRandomTile();

          // Check for game over
          if (isGameOver()) {
            endGame();
          }
        }
      }

      // Move tiles up
      function moveUp() {
        hasChanged = false;

        for (let col = 0; col < 4; col++) {
          const column = [];
          for (let row = 0; row < 4; row++) {
            column.push(grid[row][col]);
          }

          const newColumn = moveAndMerge(column);

          for (let row = 0; row < 4; row++) {
            grid[row][col] = newColumn[row];
            updateCellUI(row, col, newColumn[row]);
          }
        }

        return hasChanged;
      }

      // Move tiles down
      function moveDown() {
        hasChanged = false;

        for (let col = 0; col < 4; col++) {
          const column = [];
          for (let row = 3; row >= 0; row--) {
            column.push(grid[row][col]);
          }

          const newColumn = moveAndMerge(column);

          for (let row = 3; row >= 0; row--) {
            grid[row][col] = newColumn[3 - row];
            updateCellUI(row, col, newColumn[3 - row]);
          }
        }

        return hasChanged;
      }

      // Move tiles left
      function moveLeft() {
        hasChanged = false;

        for (let row = 0; row < 4; row++) {
          const newRow = moveAndMerge([...grid[row]]);

          for (let col = 0; col < 4; col++) {
            grid[row][col] = newRow[col];
            updateCellUI(row, col, newRow[col]);
          }
        }

        return hasChanged;
      }

      // Move tiles right
      function moveRight() {
        hasChanged = false;

        for (let row = 0; row < 4; row++) {
          const rowArray = [...grid[row]].reverse();
          const newRow = moveAndMerge(rowArray).reverse();

          for (let col = 0; col < 4; col++) {
            grid[row][col] = newRow[col];
            updateCellUI(row, col, newRow[col]);
          }
        }

        return hasChanged;
      }

      // Move and merge tiles in a line
      function moveAndMerge(line) {
        // Remove zeros
        const nonZeros = line.filter((val) => val !== 0);

        // Merge adjacent equal numbers
        const merged = [];
        for (let i = 0; i < nonZeros.length; i++) {
          if (i < nonZeros.length - 1 && nonZeros[i] === nonZeros[i + 1]) {
            const mergedValue = nonZeros[i] * 2;
            merged.push(mergedValue);
            score += mergedValue;
            scoreDisplay.textContent = score;
            i++; // Skip the next number since it's merged
            hasChanged = true;

            // Check for win condition (2048 tile)
            if (mergedValue === 2048 && !gameWon) {
              gameWon = true;
              alert("Congratulations! You reached 2048!");
              saveScoreBtn.disabled = false;
            }
          } else {
            merged.push(nonZeros[i]);
          }
        }

        // Pad with zeros to maintain length
        const result = merged.concat(Array(4 - merged.length).fill(0));

        // Check if the line has changed
        if (JSON.stringify(line) !== JSON.stringify(result)) {
          hasChanged = true;
        }

        return result;
      }

      // Check if game is over
      function isGameOver() {
        // Check for empty cells
        for (let row = 0; row < 4; row++) {
          for (let col = 0; col < 4; col++) {
            if (grid[row][col] === 0) {
              return false;
            }
          }
        }

        // Check for possible merges
        for (let row = 0; row < 4; row++) {
          for (let col = 0; col < 4; col++) {
            // Check right
            if (col < 3 && grid[row][col] === grid[row][col + 1]) {
              return false;
            }

            // Check down
            if (row < 3 && grid[row][col] === grid[row + 1][col]) {
              return false;
            }
          }
        }

        // No moves available
        return true;
      }

      // End the game
      // End the game
      function endGame() {
        gameOver = true;

        // Update final score
        finalScoreDisplay.textContent = score;
        saveScoreBtn.disabled = false;

        // Show game over overlay
        gameOverOverlay.style.display = "flex";

        // Also check if this is a new high score for immediate visual feedback
        const currentHighScore = parseInt(highScoreDisplay.textContent) || 0;
        if (score > currentHighScore) {
          // Update high score display immediately for better UX
          highScoreDisplay.textContent = score;
          console.log("New high score achieved!");
        }

        // Also fetch from server to ensure we have the latest data
        updateHighScore();
      }

      // Save score
      // Save score
      function saveScore() {
        if (score === 0) return;

        const currentUser = JSON.parse(localStorage.getItem("currentUser"));
        if (!currentUser) return;

        // Save score using API
        saveHighScore("2048", score, false)
          .then((success) => {
            if (success) {
              // Update UI to show success
              saveScoreBtn.textContent = "Score Saved!";
              saveScoreBtn.disabled = true;
              // Update high score display
              updateHighScore();

              // Update leaderboard if it's visible
              if (leaderboardDiv.style.display === "block") {
                toggleLeaderboard();
                toggleLeaderboard();
              }
            } else {
              saveScoreBtn.textContent = "Save Failed!";
              setTimeout(() => {
                saveScoreBtn.textContent = "Save Score";
                saveScoreBtn.disabled = false;
              }, 2000);
            }
          })
          .catch((error) => {
            console.error("Error saving score:", error);
            saveScoreBtn.textContent = "Save Failed!";
            setTimeout(() => {
              saveScoreBtn.textContent = "Save Score";
              saveScoreBtn.disabled = false;
            }, 2000);
          });
      }

      // Update high score display
      // Update high score display
      function updateHighScore() {
        const currentUser = JSON.parse(localStorage.getItem("currentUser"));
        if (!currentUser) return;

        // Fetch high score from API instead of localStorage
        fetch(`${window.API_URL}/sessions/stats`, {
          headers: {
            Authorization: `Bearer ${getAuthToken()}`,
          },
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Failed to fetch user stats");
            }
            return response.json();
          })
          .then((data) => {
            if (data.bestScores && data.bestScores.best_2048_score) {
              highScoreDisplay.textContent = data.bestScores.best_2048_score;
            }
          })
          .catch((error) => {
            console.error("Error fetching high score:", error);
          });
      }

      // Toggle leaderboard visibility
      // Toggle leaderboard visibility
      // Toggle leaderboard visibility
      function toggleLeaderboard() {
        if (leaderboardDiv.style.display === "none") {
          leaderboardDiv.style.display = "block";
          showLeaderboardBtn.textContent = "Hide Leaderboard";

          try {
            // Use the existing displayLeaderboard function from leaderboard.js
            displayLeaderboard("2048");
          } catch (error) {
            console.error("Error loading leaderboard:", error);
            leaderboardDiv.innerHTML = `
        <h2>Leaderboard</h2>
        <p>Error loading leaderboard. Please try again.</p>
      `;
          }
        } else {
          leaderboardDiv.style.display = "none";
          showLeaderboardBtn.textContent = "Show Leaderboard";
        }
      }
    </script>
  </body>
</html>
