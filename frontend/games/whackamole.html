<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Whack-a-Mole - Gamyverse</title>
    <link rel="stylesheet" href="../css/style.css" />
    <link rel="stylesheet" href="../css/components/header.css" />
    <link rel="stylesheet" href="../css/components/footer.css" />
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
      .game-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
      }

      .game-header {
        width: 100%;
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
      }

      .game-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }

      .game-stats {
        display: flex;
        justify-content: space-between;
        width: 100%;
        max-width: 500px;
        margin-bottom: 20px;
      }

      .game-stat {
        background-color: rgba(10, 25, 41, 0.7);
        padding: 10px 20px;
        border-radius: 5px;
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-height: 100px;
      }

      .game-stat h3 {
        margin-top: 0;
        margin-bottom: 10px;
      }

      .game-stat p {
        margin: 0;
        font-size: 24px;
      }

      .mole-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        width: 100%;
        max-width: 500px;
        aspect-ratio: 1 / 1;
      }

      .mole-hole {
        position: relative;
        background-color: #2a3e5c;
        border-radius: 50%;
        overflow: hidden;
        cursor: pointer;
      }

      .mole {
        position: absolute;
        bottom: -100%;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #4e7ac7;
        border-radius: 50%;
        transition: bottom 0.2s;
      }

      .mole.active {
        bottom: 0;
      }

      .mole .face {
        position: absolute;
        top: 20%;
        left: 50%;
        transform: translateX(-50%);
        font-size: 2rem;
      }

      .mole.whacked {
        background-color: #ff4757;
      }

      .difficulty-select {
        display: flex;
        gap: 10px;
        margin: 20px 0;
      }

      .difficulty-btn {
        padding: 8px 15px;
        background-color: #0a1929;
        border: 1px solid #4e7ac7;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .difficulty-btn.active {
        background-color: #1e4976;
        border-color: #00ffcc;
      }

      .leaderboard {
        margin-top: 30px;
        width: 100%;
        max-width: 500px;
      }

      .leaderboard table {
        width: 100%;
        border-collapse: collapse;
      }

      .leaderboard th,
      .leaderboard td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #2a3e5c;
      }

      .leaderboard th {
        background-color: #0a1929;
        color: #4e7ac7;
      }

      .game-instructions {
        margin-top: 20px;
        background-color: rgba(10, 25, 41, 0.7);
        padding: 15px;
        border-radius: 5px;
        max-width: 500px;
      }

      .game-instructions h3 {
        margin-top: 0;
      }

      .game-instructions ul {
        list-style: none;
        padding-left: 0;
        margin-left: 0;
      }

      .game-popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s;
      }

      .game-popup-overlay.active {
        opacity: 1;
        visibility: visible;
      }

      .game-popup {
        background-color: #0a1929;
        border: 2px solid #4e7ac7;
        border-radius: 10px;
        padding: 20px;
        width: 90%;
        max-width: 400px;
        text-align: center;
      }

      .game-popup h2 {
        color: #00ffcc;
        margin-top: 0;
      }

      .game-popup .popup-buttons {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 20px;
      }

      .game-popup .popup-buttons button {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
      }

      .game-popup .popup-buttons .btn-primary {
        background-color: #00ffcc;
        color: #0a1929;
      }

      .game-popup .popup-buttons .btn-secondary {
        background-color: #4e7ac7;
        color: white;
      }
    </style>
  </head>
  <body>
    <div class="gradient-background">
      <!-- Header -->
      <header class="header">
        <div class="logo">
          <a href="../dashboard.html">
            <img src="../assets/logo.png" alt="Gamyverse Logo" />
            <span>Gamyverse</span>
          </a>
        </div>
      </header>

      <!-- Game Container -->
      <div class="game-container">
        <a href="../dashboard.html" class="back-to-dashboard">
          Back to Dashboard
        </a>
        <h1 class="game-title">Whack-a-Mole</h1>

        <div class="game-controls">
          <button id="start-btn" class="btn btn-primary">Start Game</button>
          <button id="show-leaderboard-btn" class="btn btn-secondary">
            Show Leaderboard
          </button>
        </div>

        <div class="difficulty-select">
          <button class="difficulty-btn active" data-difficulty="easy">
            Easy
          </button>
          <button class="difficulty-btn" data-difficulty="medium">
            Medium
          </button>
          <button class="difficulty-btn" data-difficulty="hard">Hard</button>
        </div>

        <div class="game-stats">
          <div class="game-stat">
            <h3>Score</h3>
            <p id="score-display">0</p>
          </div>
          <div class="game-stat">
            <h3>High Score</h3>
            <p id="high-score-display">0</p>
          </div>
          <div class="game-stat">
            <h3>Time Left</h3>
            <p id="time-display">30</p>
          </div>
          <div class="game-stat">
            <h3>Moles Whacked</h3>
            <p id="moles-whacked-display">0</p>
          </div>
        </div>

        <div class="mole-grid" id="mole-grid">
          <!-- 9 mole holes -->
          <div class="mole-hole">
            <div class="mole">
              <div class="face">ðŸ˜Š</div>
            </div>
          </div>
          <div class="mole-hole">
            <div class="mole">
              <div class="face">ðŸ˜Š</div>
            </div>
          </div>
          <div class="mole-hole">
            <div class="mole">
              <div class="face">ðŸ˜Š</div>
            </div>
          </div>
          <div class="mole-hole">
            <div class="mole">
              <div class="face">ðŸ˜Š</div>
            </div>
          </div>
          <div class="mole-hole">
            <div class="mole">
              <div class="face">ðŸ˜Š</div>
            </div>
          </div>
          <div class="mole-hole">
            <div class="mole">
              <div class="face">ðŸ˜Š</div>
            </div>
          </div>
          <div class="mole-hole">
            <div class="mole">
              <div class="face">ðŸ˜Š</div>
            </div>
          </div>
          <div class="mole-hole">
            <div class="mole">
              <div class="face">ðŸ˜Š</div>
            </div>
          </div>
          <div class="mole-hole">
            <div class="mole">
              <div class="face">ðŸ˜Š</div>
            </div>
          </div>
        </div>

        <div class="game-instructions">
          <h3>How to Play:</h3>
          <p>
            Whack as many moles as you can before the time runs out! Click on a
            mole to whack it and earn points.
          </p>
          <p><strong>Difficulty:</strong></p>
          <ul>
            <li>Easy: Moles move slower, stay up longer</li>
            <li>Medium: Moles move at moderate speed</li>
            <li>Hard: Moles move faster, stay up for shorter time</li>
          </ul>
        </div>

        <div class="leaderboard" id="leaderboard" style="display: none">
          <h2>Leaderboard</h2>
          <table>
            <thead>
              <tr>
                <th>Rank</th>
                <th>Player</th>
                <th>Score</th>
                <th>Moles Whacked</th>
                <th>Difficulty</th>
              </tr>
            </thead>
            <tbody id="leaderboard-body">
              <!-- Leaderboard entries will be inserted here -->
            </tbody>
          </table>
        </div>
      </div>

      <div class="game-popup-overlay" id="game-completion-popup">
        <div class="game-popup">
          <h2>Game Over!</h2>
          <p>Your final score: <span id="final-score">0</span></p>
          <p>Moles whacked: <span id="final-moles-whacked">0</span></p>
          <div class="popup-buttons">
            <button id="popup-save-score" class="btn-primary">
              Save Score
            </button>
            <button id="popup-play-again" class="btn-secondary">
              Play Again
            </button>
          </div>
        </div>
      </div>

      <footer class="footer">
        <div class="footer-content">
          <div class="footer-logo-title">
            <span>Gamyverse</span>
            <p class="footer-tagline">An Ultimate Gaming Universe</p>
          </div>
          <div class="footer-social">
            <a href="mailto:snehaagarwal1322@gmail.com" aria-label="Gmail">
              <i data-feather="mail"></i>
            </a>
            <a
              href="https://www.linkedin.com/in/snehaagarwal03"
              aria-label="LinkedIn"
              target="_blank"
            >
              <i data-feather="linkedin"></i>
            </a>
            <a
              href="https://github.com/snehaagarwal03"
              aria-label="GitHub"
              target="_blank"
            >
              <i data-feather="github"></i>
            </a>
          </div>
        </div>
        <div class="footer-bottom">
          <p>&copy; 2025 Gamyverse. All rights reserved.</p>
        </div>
      </footer>
    </div>

    <script src="../js/auth.js"></script>
    <script src="../js/games.js"></script>
    <script src="../js/leaderboard.js"></script>
    <script>
      // Initialize Feather icons
      document.addEventListener("DOMContentLoaded", () => {
        feather.replace();

        // Check if user is logged in
        checkAuthStatus();

        // Update high score display
        updateHighScore();

        // Logout button functionality
      });

      // Game variables
      let score = 0;
      let timeLeft = 30;
      let gameInterval;
      let moleInterval;
      let gameRunning = false;
      let difficulty = "easy";
      let molesWhacked = 0;
      let difficultySettings = {
        easy: { minDelay: 1000, maxDelay: 2000, visibleTime: 1500 },
        medium: { minDelay: 800, maxDelay: 1600, visibleTime: 1200 },
        hard: { minDelay: 700, maxDelay: 1400, visibleTime: 1000 },
      };

      // DOM elements
      const startBtn = document.getElementById("start-btn");
      const showLeaderboardBtn = document.getElementById(
        "show-leaderboard-btn"
      );
      const scoreDisplay = document.getElementById("score-display");
      const highScoreDisplay = document.getElementById("high-score-display");
      const timeDisplay = document.getElementById("time-display");
      const molesWhackedDisplay = document.getElementById(
        "moles-whacked-display"
      );
      const moleGrid = document.getElementById("mole-grid");
      const moles = document.querySelectorAll(".mole");
      const difficultyBtns = document.querySelectorAll(".difficulty-btn");
      const leaderboardDiv = document.getElementById("leaderboard");
      const gameCompletionPopup = document.getElementById(
        "game-completion-popup"
      );
      const finalScoreDisplay = document.getElementById("final-score");
      const finalMolesWhackedDisplay = document.getElementById(
        "final-moles-whacked"
      );
      const popupSaveScoreBtn = document.getElementById("popup-save-score");
      const popupPlayAgainBtn = document.getElementById("popup-play-again");

      // Add event listeners
      popupSaveScoreBtn.addEventListener("click", () => {
        // Save score and close popup immediately
        saveHighScore("whackamole", score, false, {
          difficultyLevel: difficulty,
          molesWhacked: molesWhacked,
        });
        updateHighScore();
        // Hide popup immediately
        hideGameCompletionPopup();
      });

      popupPlayAgainBtn.addEventListener("click", () => {
        // Just hide popup and reset game, but DON'T start a new game
        hideGameCompletionPopup();
        resetGame();
      });

      // Event listeners
      startBtn.addEventListener("click", startGame);
      showLeaderboardBtn.addEventListener("click", toggleLeaderboard);

      // Add click event to each mole
      moles.forEach((mole) => {
        mole.addEventListener("click", () => {
          if (!gameRunning || !mole.classList.contains("active")) return;

          // Whack the mole
          whackMole(mole);
        });
      });

      // Set difficulty
      difficultyBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          if (gameRunning) return;

          difficultyBtns.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          difficulty = btn.getAttribute("data-difficulty");
        });
      });

      // Start game
      function startGame() {
        if (gameRunning) return;

        // Reset game state
        resetGame();

        // Start game loop
        gameRunning = true;
        startBtn.textContent = "Restart New Game";
        startBtn.disabled = false;

        // Start timer
        gameInterval = setInterval(() => {
          timeLeft--;
          timeDisplay.textContent = timeLeft;

          if (timeLeft <= 0) {
            endGame();
          }
        }, 1000);

        // Start showing moles
        showRandomMole();
      }

      // Reset game
      function resetGame() {
        score = 0;
        timeLeft = 30;
        molesWhacked = 0;
        scoreDisplay.textContent = score;
        timeDisplay.textContent = timeLeft;
        molesWhackedDisplay.textContent = molesWhacked;

        // Hide all moles
        moles.forEach((mole) => {
          mole.classList.remove("active");
          mole.classList.remove("whacked");
        });

        // Clear intervals
        if (gameInterval) clearInterval(gameInterval);
        if (moleInterval) clearTimeout(moleInterval);

        startBtn.textContent = "Start Game";
        startBtn.disabled = false;

        // Hide completion popup if visible
        hideGameCompletionPopup();
      }

      // Show random mole
      function showRandomMole() {
        // Get random mole
        const randomIndex = Math.floor(Math.random() * moles.length);
        const mole = moles[randomIndex];

        // Make sure mole is not already active
        if (mole.classList.contains("active")) {
          showRandomMole();
          return;
        }

        // Show mole
        mole.classList.add("active");
        mole.classList.remove("whacked");

        // Get settings based on difficulty
        const settings = difficultySettings[difficulty];

        // Hide mole after some time
        setTimeout(() => {
          if (mole.classList.contains("active")) {
            mole.classList.remove("active");
          }
        }, settings.visibleTime);

        // Schedule next mole
        const delay =
          Math.random() * (settings.maxDelay - settings.minDelay) +
          settings.minDelay;
        moleInterval = setTimeout(showRandomMole, delay);
      }

      // Whack a mole
      function whackMole(mole) {
        // Check if mole is active
        if (!mole.classList.contains("active") || !gameRunning) return;

        // Mark as whacked
        mole.classList.add("whacked");
        mole.classList.remove("active");

        // Change face
        mole.querySelector(".face").textContent = "ðŸ˜µ";

        // Increase score
        score += 10;
        scoreDisplay.textContent = score;

        // Increment and display moles whacked
        molesWhacked++;
        molesWhackedDisplay.textContent = molesWhacked;

        // Reset face after a short delay
        setTimeout(() => {
          mole.querySelector(".face").textContent = "ðŸ˜Š";
        }, 500);
      }

      // End game
      function endGame() {
        // Stop game loop
        clearInterval(gameInterval);
        clearTimeout(moleInterval);
        gameRunning = false;

        // Reset button
        startBtn.textContent = "Start Game";
        startBtn.disabled = false;

        // Hide all moles
        moles.forEach((mole) => {
          mole.classList.remove("active");
          mole.classList.remove("whacked");
        });

        const currentHighScore = parseInt(highScoreDisplay.textContent) || 0;
        if (score > currentHighScore) {
          // Update high score display immediately for better user experience
          highScoreDisplay.textContent = score;
          console.log("New high score achieved!");
        }

        // Also fetch from server to ensure we have the latest data
        updateHighScore();

        // Show game completion popup
        showGameCompletionPopup();
      }

      // Save score
      function saveScore() {
        if (score === 0) return;

        const currentUser = JSON.parse(localStorage.getItem("currentUser"));
        if (!currentUser) return;
        // Save score using the API
        saveHighScore("whackamole", score, false, {
          difficultyLevel: difficulty,
          molesWhacked: molesWhacked,
        })
          .then((success) => {
            if (success) {
              console.log("Score saved successfully");
              // Update visual feedback
              // Update the leaderboard if it's visible
              if (leaderboardDiv.style.display === "block") {
                displayLeaderboard("whackamole");
              }

              // Update high score display
              updateHighScore();
            } else {
              console.error("Failed to save score");
            }
          })
          .catch((error) => {
            console.error("Error saving score:", error);
          });
      }

      // Update high score display
      function updateHighScore() {
        const currentUser = JSON.parse(localStorage.getItem("currentUser"));
        if (!currentUser) return;

        // Fetch high score from API instead of localStorage
        fetch(`${window.API_URL}/sessions/stats`, {
          headers: {
            Authorization: `Bearer ${getAuthToken()}`,
          },
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Failed to fetch user stats");
            }
            return response.json();
          })
          .then((data) => {
            if (data.bestScores && data.bestScores.best_whackamole_score) {
              highScoreDisplay.textContent =
                data.bestScores.best_whackamole_score;
            }
          })
          .catch((error) => {
            console.error("Error fetching high score:", error);
          });
      }

      function toggleLeaderboard() {
        if (leaderboardDiv.style.display === "none") {
          leaderboardDiv.style.display = "block";
          showLeaderboardBtn.textContent = "Hide Leaderboard";

          try {
            // Display leaderboard with error handling
            displayLeaderboard("whackamole");
          } catch (error) {
            console.error("Error loading leaderboard:", error);
            leaderboardDiv.innerHTML =
              "<p>Error loading leaderboard. Please try again.</p>";
          }
        } else {
          leaderboardDiv.style.display = "none";
          showLeaderboardBtn.textContent = "Show Leaderboard";
        }
      }

      // Show game completion popup
      function showGameCompletionPopup() {
        gameCompletionPopup.classList.add("active");
        finalScoreDisplay.textContent = score;
        finalMolesWhackedDisplay.textContent = molesWhacked;

        if (score === 0) {
          popupSaveScoreBtn.disabled = true;
          popupSaveScoreBtn.textContent = "Score must be > 0";
        }
      }
      // Hide game completion popup
      function hideGameCompletionPopup() {
        gameCompletionPopup.classList.remove("active");
      }
    </script>
  </body>
</html>
