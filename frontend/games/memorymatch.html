<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Memory Match - Gamyverse</title>
    <link rel="stylesheet" href="../css/style.css" />
    <link rel="stylesheet" href="../css/components/header.css" />
    <link rel="stylesheet" href="../css/components/footer.css" />
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
      .game-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
      }

      .game-header {
        width: 100%;
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
      }

      .game-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }

      .game-stats {
        display: flex;
        justify-content: space-between;
        width: 100%;
        max-width: 600px;
        margin-bottom: 20px;
      }

      .game-stat {
        background-color: rgba(10, 25, 41, 0.7);
        padding: 10px 20px;
        border-radius: 5px;
        text-align: center;
      }

      .btn-active {
        transform: scale(0.95);
        box-shadow: 0 0 10px rgba(0, 255, 204, 0.5);
        transition: all 0.1s;
      }

      .memory-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
        width: 100%;
        max-width: 600px;
      }

      .memory-card {
        height: 120px;
        perspective: 1000px;
        cursor: pointer;
      }

      .memory-card-inner {
        position: relative;
        width: 100%;
        height: 100%;
        transition: transform 0.6s;
        transform-style: preserve-3d;
      }

      .memory-card.flipped .memory-card-inner {
        transform: rotateY(180deg);
      }

      .memory-card-front,
      .memory-card-back {
        position: absolute;
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
        border-radius: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .memory-card-front {
        background: linear-gradient(
          135deg,
          var(--primary-dark) 0%,
          var(--primary) 100%
        );
      }

      .memory-card-back {
        background-color: var(--bg-dark);
        transform: rotateY(180deg);
        font-size: 2.5rem;
        color: var(--secondary);
      }

      .memory-card-front i {
        font-size: 2rem;
        color: var(--bg-darkest);
      }

      .memory-card.matched .memory-card-back {
        background-color: rgba(0, 255, 204, 0.2);
      }

      .difficulty-select {
        display: flex;
        gap: 10px;
        margin: 20px 0;
      }

      .difficulty-btn {
        padding: 8px 15px;
        background-color: var(--bg-darkest);
        border: 1px solid var(--primary);
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.2s;
        color: var(--text-light);
      }

      .difficulty-btn.active {
        background-color: var(--primary-dark);
        border-color: var(--secondary);
      }

      .leaderboard {
        margin-top: 30px;
        width: 100%;
        max-width: 600px;
      }

      .leaderboard table {
        width: 100%;
        border-collapse: collapse;
      }

      .leaderboard th,
      .leaderboard td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid var(--bg-medium);
      }

      .leaderboard th {
        background-color: var(--bg-darkest);
        color: var(--primary);
      }

      .game-instructions {
        margin-top: 20px;
        background-color: rgba(10, 25, 41, 0.7);
        padding: 15px;
        border-radius: 5px;
        max-width: 600px;
      }

      .game-instructions h3 {
        margin-top: 0;
      }

      .game-over-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(10, 25, 41, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
      }

      .game-over-modal.active {
        opacity: 1;
        pointer-events: auto;
      }

      .modal-content {
        background-color: var(--bg-dark);
        padding: 30px;
        border-radius: 10px;
        text-align: center;
        max-width: 400px;
        width: 90%;
        box-shadow: var(--shadow-dark);
      }

      .modal-content h2 {
        color: var(--secondary);
        margin-top: 0;
      }

      .modal-content p {
        margin-bottom: 20px;
      }

      .modal-buttons {
        display: flex;
        justify-content: center;
        gap: 10px;
      }

      @media (max-width: 768px) {
        .memory-grid {
          grid-template-columns: repeat(4, 1fr);
        }

        .memory-card {
          height: 80px;
        }
      }

      @media (max-width: 480px) {
        .memory-grid {
          grid-template-columns: repeat(3, 1fr);
        }

        .game-stats {
          flex-direction: column;
          gap: 10px;
        }
      }
    </style>
  </head>
  <body>
    <div class="gradient-background">
      <header class="header">
        <div class="logo">
          <a href="../dashboard.html">
            <img src="../assets/logo.png" alt="Gamyverse Logo" />
            <span>Gamyverse</span>
          </a>
        </div>
      </header>

      <div class="game-container">
        <a href="../dashboard.html" class="back-to-dashboard">
          Back to Dashboard
        </a>
        <h1 class="game-title">Memory Match</h1>

        <div class="game-controls">
          <button id="new-game-btn" class="btn btn-primary">New Game</button>
          <button id="show-leaderboard-btn" class="btn btn-secondary">
            Show Leaderboard
          </button>
        </div>

        <div class="difficulty-select">
          <button class="difficulty-btn active" data-pairs="8">
            Easy (8 pairs)
          </button>
          <button class="difficulty-btn" data-pairs="10">
            Medium (10 pairs)
          </button>
          <button class="difficulty-btn" data-pairs="12">
            Hard (12 pairs)
          </button>
        </div>

        <div class="game-stats">
          <div class="game-stat">
            <h3>Moves</h3>
            <p id="moves-count">0</p>
          </div>
          <div class="game-stat">
            <h3>Pairs Found</h3>
            <p>
              <span id="pairs-found">0</span>/<span id="total-pairs">8</span>
            </p>
          </div>
          <div class="game-stat">
            <h3>Time</h3>
            <p id="time-display">00:00</p>
          </div>
          <div class="game-stat">
            <h3>Best Time</h3>
            <p id="best-time-display">--:--</p>
          </div>
        </div>

        <div class="memory-grid" id="memory-grid">
          <!-- Cards will be generated dynamically -->
        </div>

        <div class="game-instructions">
          <h3>How to Play:</h3>
          <p>
            Find all matching pairs of cards by turning them over two at a time.
            The game is complete when all pairs are found.
          </p>
          <p>
            <strong>Controls:</strong> Click on cards to flip them over and find
            matching pairs.
          </p>
        </div>

        <div class="leaderboard" id="leaderboard" style="display: none">
          <h2>Leaderboard</h2>
          <table>
            <thead>
              <tr>
                <th>Rank</th>
                <th>Player</th>
                <th>Time</th>
                <th>Moves</th>
                <th>Difficulty</th>
              </tr>
            </thead>
            <tbody id="leaderboard-body">
              <!-- Leaderboard entries will be inserted here -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Game Over Modal -->
      <div class="game-over-modal" id="game-over-modal">
        <div class="modal-content">
          <h2>Congratulations!</h2>
          <p>
            You've found all pairs in <span id="final-time">00:00</span> with
            <span id="final-moves">0</span> moves!
          </p>
          <div class="modal-buttons">
            <button id="play-again-btn" class="btn btn-primary">
              Play Again
            </button>
            <button id="modal-save-score-btn" class="btn btn-secondary">
              Save Score
            </button>
          </div>
        </div>
      </div>

      <footer class="footer">
        <div class="footer-content">
          <div class="footer-logo-title">
            <span>Gamyverse</span>
            <p class="footer-tagline">An Ultimate Gaming Universe</p>
          </div>
          <div class="footer-social">
            <a href="mailto:snehaagarwal1322@gmail.com" aria-label="Gmail">
              <i data-feather="mail"></i>
            </a>
            <a
              href="https://www.linkedin.com/in/snehaagarwal03"
              aria-label="LinkedIn"
              target="_blank"
            >
              <i data-feather="linkedin"></i>
            </a>
            <a
              href="https://github.com/snehaagarwal03"
              aria-label="GitHub"
              target="_blank"
            >
              <i data-feather="github"></i>
            </a>
          </div>
        </div>
        <div class="footer-bottom">
          <p>&copy; 2025 Gamyverse. All rights reserved.</p>
        </div>
      </footer>
    </div>

    <script src="../js/auth.js"></script>
    <script src="../js/games.js"></script>
    <script src="../js/leaderboard.js"></script>
    <script>
      // Initialize Feather icons
      document.addEventListener("DOMContentLoaded", () => {
        feather.replace();

        // Check if user is logged in
        checkAuthStatus();

        // Update best time display
        updateBestTime();
      });

      // Game variables
      let cards = [];
      let flippedCards = [];
      let matchedPairs = 0;
      let totalPairs = 8; // Default to easy
      let moves = 0;
      let gameStarted = false;
      let gameTimer;
      let seconds = 0;
      let canFlip = false;
      let currentDifficulty = "Easy (8 pairs)";

      // Card icons (Feather icons) - ensure we have enough for hardest difficulty
      const cardIcons = [
        "heart",
        "star",
        "circle",
        "square",
        "triangle",
        "award",
        "bell",
        "bookmark",
        "camera",
        "cloud",
        "coffee",
        "gift",
        "globe",
        "home",
        "music",
        "sun",
        "moon",
        "umbrella",
        "truck",
        "thumbs-up",
        "smile",
        "shopping-cart",
        "map",
      ];

      // DOM elements
      const memoryGrid = document.getElementById("memory-grid");
      const newGameBtn = document.getElementById("new-game-btn");
      const showLeaderboardBtn = document.getElementById(
        "show-leaderboard-btn"
      );
      const movesDisplay = document.getElementById("moves-count");
      const pairsFoundDisplay = document.getElementById("pairs-found");
      const totalPairsDisplay = document.getElementById("total-pairs");
      const timeDisplay = document.getElementById("time-display");
      const bestTimeDisplay = document.getElementById("best-time-display");
      const difficultyBtns = document.querySelectorAll(".difficulty-btn");
      const leaderboardDiv = document.getElementById("leaderboard");
      const gameOverModal = document.getElementById("game-over-modal");
      const finalTimeDisplay = document.getElementById("final-time");
      const finalMovesDisplay = document.getElementById("final-moves");
      const playAgainBtn = document.getElementById("play-again-btn");
      const modalSaveScoreBtn = document.getElementById("modal-save-score-btn");

      // Event listeners
      newGameBtn.addEventListener("click", startNewGame);
      showLeaderboardBtn.addEventListener("click", toggleLeaderboard);
      playAgainBtn.addEventListener("click", () => {
        closeModal();
      });
      modalSaveScoreBtn.addEventListener("click", () => {
        saveScore();
        modalSaveScoreBtn.disabled = true;
      });

      // Add click event to difficulty buttons
      // Add click event to difficulty buttons
      difficultyBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          if (gameStarted) {
            if (
              !confirm(
                "Changing difficulty will reset the current game. Continue?"
              )
            ) {
              return;
            }

            // If a game is in progress, stop the timer
            clearInterval(gameTimer);
            gameStarted = false;
          }

          difficultyBtns.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          totalPairs = parseInt(btn.getAttribute("data-pairs"));
          totalPairsDisplay.textContent = totalPairs;
          currentDifficulty = btn.textContent;

          // Reset the grid without starting the game
          flippedCards = [];
          matchedPairs = 0;
          moves = 0;
          seconds = 0;
          canFlip = false; // Keep cards unflippable until New Game is clicked

          // Update displays
          pairsFoundDisplay.textContent = "0";
          movesDisplay.textContent = "0";
          timeDisplay.textContent = "00:00";

          // Initialize the grid without starting the game
          initializeGrid();
        });
      });
      // Initialize game for the first time
      initializeGrid();

      // Initialize grid
      function initializeGrid() {
        memoryGrid.innerHTML = "";
        cards = [];

        // Calculate grid layout based on total pairs
        let cols;
        if (totalPairs <= 8) cols = 4;
        else if (totalPairs <= 10) cols = 5;
        else cols = 6;

        // Update grid columns
        memoryGrid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

        // Create cards
        const selectedIcons = shuffleArray(cardIcons).slice(0, totalPairs);
        const cardPairs = [...selectedIcons, ...selectedIcons];
        cards = shuffleArray(cardPairs);

        // Clear grid and create new cards
        memoryGrid.innerHTML = "";

        cards.forEach((icon, index) => {
          const card = document.createElement("div");
          card.className = "memory-card";
          card.setAttribute("data-index", index);
          card.setAttribute("data-icon", icon);

          card.innerHTML = `
                    <div class="memory-card-inner">
                        <div class="memory-card-front">
                            <i data-feather="help-circle"></i>
                        </div>
                        <div class="memory-card-back">
                            <i data-feather="${icon}"></i>
                        </div>
                    </div>
                `;

          card.addEventListener("click", () => flipCard(card, index));
          memoryGrid.appendChild(card);
        });

        // Initialize Feather icons for cards
        feather.replace();
      }

      // Start new game
      function startNewGame() {
        // Reset game state
        flippedCards = [];
        matchedPairs = 0;
        moves = 0;
        seconds = 0;

        if (gameTimer) clearInterval(gameTimer);
        // Update displays
        pairsFoundDisplay.textContent = moves;
        movesDisplay.textContent = matchedPairs;
        timeDisplay.textContent = "00:00";

        newGameBtn.classList.add("btn-active");
        setTimeout(() => {
          newGameBtn.classList.remove("btn-active");
        }, 200);

        // Create new game
        initializeGrid();
        startTimer();
        canFlip = true;
        gameStarted = true;
      }

      // Start timer
      function startTimer() {
        gameTimer = setInterval(() => {
          seconds++;
          const minutes = Math.floor(seconds / 60)
            .toString()
            .padStart(2, "0");
          const secs = (seconds % 60).toString().padStart(2, "0");
          timeDisplay.textContent = `${minutes}:${secs}`;
        }, 1000);
      }

      // Flip a card
      function flipCard(card, index) {
        // Return if card is already flipped or matched, or if can't flip
        if (
          !canFlip ||
          card.classList.contains("flipped") ||
          card.classList.contains("matched")
        ) {
          return;
        }

        // Start the timer on first card flip if game hasn't started yet

        // Flip the card
        card.classList.add("flipped");

        // Add to flipped cards
        flippedCards.push({ card, index });

        // If we have 2 flipped cards, check for a match
        if (flippedCards.length === 2) {
          moves++;
          movesDisplay.textContent = moves;
          canFlip = false;

          setTimeout(() => {
            checkForMatch();
            canFlip = true;
          }, 800);
        }
      }

      // Check if the two flipped cards match
      function checkForMatch() {
        const [card1, card2] = flippedCards;

        // If icons match
        if (cards[card1.index] === cards[card2.index]) {
          // Mark as matched
          card1.card.classList.add("matched");
          card2.card.classList.add("matched");

          // Increment matched pairs
          matchedPairs++;
          pairsFoundDisplay.textContent = matchedPairs;

          // Check if game is complete
          if (matchedPairs === totalPairs) {
            endGame();
          }
        } else {
          // Flip cards back
          card1.card.classList.remove("flipped");
          card2.card.classList.remove("flipped");
        }

        // Clear flipped cards
        flippedCards = [];
      }

      // End game
      function endGame() {
        // Stop timer
        clearInterval(gameTimer);
        gameStarted = false;

        // Format final time
        const minutes = Math.floor(seconds / 60)
          .toString()
          .padStart(2, "0");
        const secs = (seconds % 60).toString().padStart(2, "0");
        const finalTime = `${minutes}:${secs}`;

        // Update final displays
        finalTimeDisplay.textContent = finalTime;
        finalMovesDisplay.textContent = moves;

        // Check if this is a new best time and update UI immediately for feedback
        const currentHighScore = timeToSeconds(bestTimeDisplay.textContent);
        if (currentHighScore === 0 || seconds < currentHighScore) {
          bestTimeDisplay.textContent = finalTime;
        }

        // Also fetch from server to ensure we have the latest data
        updateBestTime();

        // Enable the modal save score button
        modalSaveScoreBtn.disabled = false;
        modalSaveScoreBtn.textContent = "Save Score";

        // Show game over modal
        showModal();
      }
      // Save score
      // Save score
      function saveScore() {
        if (matchedPairs !== totalPairs) return;

        // Disable save button immediately to prevent multiple clicks
        modalSaveScoreBtn.disabled = false;

        let difficultyLevel = "easy";
        if (totalPairs === 8) difficultyLevel = "easy";
        else if (totalPairs === 10) difficultyLevel = "medium";
        else if (totalPairs >= 12) difficultyLevel = "hard";
        // Save score using API
        saveHighScore("memorymatch", seconds, true, {
          moves: moves,
          difficultyLevel: difficultyLevel,
        })
          .then((success) => {
            if (success) {
              // Update UI to show success
              modalSaveScoreBtn.textContent = "Score Saved!";
              modalSaveScoreBtn.disabled = true; // Keep it disabled

              // Update best time display
              updateBestTime();

              // Update leaderboard if it's visible
              if (leaderboardDiv.style.display === "block") {
                toggleLeaderboard();
                toggleLeaderboard();
              }
            } else {
              modalSaveScoreBtn.textContent = "Save Failed!";
              setTimeout(() => {
                modalSaveScoreBtn.textContent = "Save Score";
                modalSaveScoreBtn.disabled = false;
              }, 2000);
            }
          })
          .catch((error) => {
            console.error("Error saving score:", error);
            if (modalSaveScoreBtn) {
              modalSaveScoreBtn.textContent = "Save Failed!";
              setTimeout(() => {
                modalSaveScoreBtn.textContent = "Save Score";
                modalSaveScoreBtn.disabled = false;
              }, 2000);
            }
          });
      }

      // Update best time display
      // Update best time display
      function updateBestTime() {
        const currentUser = JSON.parse(localStorage.getItem("currentUser"));
        if (!currentUser) return;

        // Fetch best time from API instead of localStorage
        fetch(`${window.API_URL}/sessions/stats`, {
          headers: {
            Authorization: `Bearer ${getAuthToken()}`,
          },
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Failed to fetch user stats");
            }
            return response.json();
          })
          .then((data) => {
            if (data.bestScores && data.bestScores.best_memorymatch_time) {
              // Convert seconds to MM:SS format for display
              const bestTimeSeconds = data.bestScores.best_memorymatch_time;
              const minutes = Math.floor(bestTimeSeconds / 60)
                .toString()
                .padStart(2, "0");
              const secs = (bestTimeSeconds % 60).toString().padStart(2, "0");
              bestTimeDisplay.textContent = `${minutes}:${secs}`;
            } else {
              bestTimeDisplay.textContent = "--:--";
            }
          })
          .catch((error) => {
            console.error("Error fetching best time:", error);
            bestTimeDisplay.textContent = "--:--";
          });
      }

      // Toggle leaderboard visibility
      // Toggle leaderboard visibility
      function toggleLeaderboard() {
        if (leaderboardDiv.style.display === "none") {
          leaderboardDiv.style.display = "block";
          showLeaderboardBtn.textContent = "Hide Leaderboard";

          try {
            // Use the existing displayLeaderboard function from leaderboard.js
            displayLeaderboard("memorymatch");
          } catch (error) {
            console.error("Error loading leaderboard:", error);
            leaderboardDiv.innerHTML = `
        <h2>Leaderboard</h2>
        <p>Error loading leaderboard. Please try again.</p>
      `;
          }
        } else {
          leaderboardDiv.style.display = "none";
          showLeaderboardBtn.textContent = "Show Leaderboard";
        }
      }

      // Show game over modal
      function showModal() {
        gameOverModal.classList.add("active");
      }

      // Close game over modal
      function closeModal() {
        gameOverModal.classList.remove("active");
        canFlip = false;
        gameStarted = false;
        clearInterval(gameTimer);
        timeDisplay.textContent = "00:00";
        pairsFoundDisplay.textContent = "0";
        movesDisplay.textContent = "0";
        flippedCards = [];
        initializeGrid();
      }

      // Convert time string to seconds
      function timeToSeconds(timeStr) {
        const [minutes, seconds] = timeStr.split(":").map(Number);
        return minutes * 60 + seconds;
      }

      // Shuffle array
      function shuffleArray(array) {
        const newArray = [...array];
        for (let i = newArray.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
        }
        return newArray;
      }
    </script>
  </body>
</html>
