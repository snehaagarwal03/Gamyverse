<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sudoku - Gamyverse</title>
    <link rel="icon" type="image/png" href="../assets/logo.png" />
    <link rel="stylesheet" href="../css/style.css" />
    <link rel="stylesheet" href="../css/components/header.css" />
    <link rel="stylesheet" href="../css/components/footer.css" />
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
      .game-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
      }

      .game-header {
        width: 100%;
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
      }

      .game-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
      }

      .sudoku-board {
        display: grid;
        grid-template-columns: repeat(9, 1fr);
        grid-template-rows: repeat(9, 1fr);
        gap: 1px;
        background-color: #2a3e5c;
        border: 2px solid #4e7ac7;
        max-width: 450px;
        width: 100%;
        aspect-ratio: 1 / 1;
      }

      .sudoku-cell {
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #0a1929;
        font-size: clamp(16px, 4vw, 24px);
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .sudoku-cell:hover {
        background-color: #1a2a3a;
      }

      .sudoku-cell.selected {
        background-color: #1e4976;
      }

      .sudoku-cell.fixed {
        color: #4e7ac7;
      }

      .sudoku-cell.error {
        color: #ff4757;
      }

      .sudoku-cell:nth-child(3n) {
        border-right: 2px solid #4e7ac7;
      }

      .sudoku-cell:nth-child(9n) {
        border-right: none;
      }

      .sudoku-cell:nth-child(n + 19):nth-child(-n + 27),
      .sudoku-cell:nth-child(n + 46):nth-child(-n + 54) {
        border-bottom: 2px solid #4e7ac7;
      }

      .game-info {
        display: flex;
        justify-content: space-between;
        width: 100%;
        max-width: 450px;
        margin: 20px 0;
      }

      .timer,
      .difficulty {
        background-color: rgba(10, 25, 41, 0.7);
        padding: 10px;
        border-radius: 5px;
        text-align: center;
      }

      .difficulty-select {
        display: flex;
        gap: 10px;
        margin: 20px 0;
      }

      .difficulty-btn {
        padding: 8px 15px;
        background-color: #0a1929;
        border: 1px solid #4e7ac7;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .difficulty-btn.active {
        background-color: #1e4976;
        border-color: #00ffcc;
      }

      .leaderboard {
        margin-top: 30px;
        width: 100%;
        max-width: 500px;
      }

      .leaderboard table {
        width: 100%;
        border-collapse: collapse;
      }

      .leaderboard th,
      .leaderboard td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #2a3e5c;
      }

      .leaderboard th {
        background-color: #0a1929;
        color: #4e7ac7;
      }

      .game-instructions {
        margin-top: 20px;
        background-color: rgba(10, 25, 41, 0.7);
        padding: 15px;
        border-radius: 5px;
        max-width: 500px;
      }

      .game-instructions h3 {
        margin-top: 0;
      }

      .game-popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
      }

      .game-popup-overlay.active {
        opacity: 1;
        visibility: visible;
      }

      .game-popup {
        background-color: #0a1929;
        border: 2px solid #4e7ac7;
        border-radius: 10px;
        padding: 20px;
        width: 90%;
        max-width: 400px;
        text-align: center;
        position: relative;
        transform: scale(0.8);
        transition: transform 0.3s;
      }

      .game-popup-overlay.active .game-popup {
        transform: scale(1);
      }

      .game-popup h2 {
        color: #00ffcc;
        margin-top: 0;
      }

      .game-popup p {
        margin: 15px 0;
        font-size: 18px;
      }

      .game-popup .popup-buttons {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 20px;
      }

      .game-popup .popup-buttons button {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.2s;
      }

      .game-popup .popup-buttons .btn-primary {
        background-color: #00ffcc;
        color: #0a1929;
      }

      .game-popup .popup-buttons .btn-secondary {
        background-color: #4e7ac7;
        color: white;
      }

      .game-popup .popup-buttons button:hover {
        opacity: 0.9;
      }

      @media (max-width: 500px) {
        .game-popup {
          padding: 15px;
        }

        .game-popup .popup-buttons {
          flex-direction: column;
          gap: 10px;
        }
      }
    </style>
  </head>
  <body>
    <div class="gradient-background">
      <header class="header">
        <div class="logo">
          <a href="../dashboard.html">
            <img src="../assets/logo.png" alt="Gamyverse Logo" />
            <span>Gamyverse</span>
          </a>
        </div>
      </header>

      <div class="game-container">
        <a href="../dashboard.html" class="back-to-dashboard">
          Back to Dashboard
        </a>
        <h1 class="game-title">Sudoku</h1>

        <div class="game-controls">
          <button id="start-game-btn" class="btn btn-primary">
            Start Game
          </button>
          <button id="check-btn" class="btn btn-secondary">
            Check Solution
          </button>
          <button id="show-leaderboard-btn" class="btn btn-secondary">
            Show Leaderboard
          </button>
        </div>

        <div class="difficulty-select">
          <button class="difficulty-btn active" data-difficulty="easy">
            Easy
          </button>
          <button class="difficulty-btn" data-difficulty="medium">
            Medium
          </button>
          <button class="difficulty-btn" data-difficulty="hard">Hard</button>
        </div>

        <div class="game-info">
          <div class="timer">Time: <span id="timer-display">00:00</span></div>
          <div class="difficulty">
            Difficulty: <span id="difficulty-display">Easy</span>
          </div>
        </div>

        <div class="sudoku-board" id="sudoku-board"></div>

        <div class="game-instructions">
          <h3>How to Play:</h3>
          <p>
            Fill in the grid so that every row, column, and 3Ã—3 box contains the
            digits 1 through 9 without repetition.
          </p>
          <p>
            <strong>Controls:</strong> Click on a cell to select it, then click
            a number to place it. Click "Clear" to empty a cell.
          </p>
        </div>

        <div class="leaderboard" id="leaderboard" style="display: none">
          <h2>Leaderboard</h2>
          <table>
            <thead>
              <tr>
                <th>Rank</th>
                <th>Player</th>
                <th>Time</th>
                <th>Difficulty</th>
              </tr>
            </thead>
            <tbody id="leaderboard-body"></tbody>
          </table>
        </div>
      </div>

      <div class="game-popup-overlay" id="game-completion-popup">
        <div class="game-popup">
          <h2>Game Over!</h2>
          <p>Congratulations! You completed the puzzle.</p>
          <p>Your time: <span id="completion-time">00:00</span></p>
          <div class="popup-buttons">
            <button id="popup-save-score" class="btn-primary">
              Save Score
            </button>
            <button id="popup-play-again" class="btn-secondary">
              Play Again
            </button>
          </div>
        </div>
      </div>

      <div class="game-popup-overlay" id="check-solution-popup">
        <div class="game-popup">
          <h2>Show Solution?</h2>
          <p>Do you want to see the solution?</p>
          <p>
            Your score will not be recorded if you choose to see the solution.
          </p>
          <div class="popup-buttons">
            <button id="show-solution-yes" class="btn-secondary">Yes</button>
            <button id="show-solution-no" class="btn-primary">No</button>
          </div>
        </div>
      </div>

      <footer class="footer">
        <div class="footer-content">
          <div class="footer-logo-title">
            <span>Gamyverse</span>
            <p class="footer-tagline">An Ultimate Gaming Universe</p>
          </div>
          <div class="footer-social">
            <a href="mailto:snehaagarwal1322@gmail.com" aria-label="Gmail">
              <i data-feather="mail"></i>
            </a>
            <a
              href="https://www.linkedin.com/in/snehaagarwal03"
              aria-label="LinkedIn"
              target="_blank"
            >
              <i data-feather="linkedin"></i>
            </a>
            <a
              href="https://github.com/snehaagarwal03"
              aria-label="GitHub"
              target="_blank"
            >
              <i data-feather="github"></i>
            </a>
          </div>
        </div>
        <div class="footer-bottom">
          <p>&copy; 2025 Gamyverse. All rights reserved.</p>
        </div>
      </footer>
    </div>

    <script src="../js/auth.js"></script>
    <script src="../js/games.js"></script>
    <script src="../js/leaderboard.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        feather.replace();
        checkAuthStatus();
      });

      let selectedCell = null;
      let board = Array(9)
        .fill()
        .map(() => Array(9).fill(0));
      let solution = Array(9)
        .fill()
        .map(() => Array(9).fill(0));
      let fixedCells = Array(9)
        .fill()
        .map(() => Array(9).fill(false));
      let timer = 0;
      let timerInterval;
      let gameStarted = false;
      let difficulty = "easy";
      let gameWon = false;

      const sudokuBoard = document.getElementById("sudoku-board");
      const startGameBtn = document.getElementById("start-game-btn");
      const checkBtn = document.getElementById("check-btn");
      const showLeaderboardBtn = document.getElementById(
        "show-leaderboard-btn"
      );
      const timerDisplay = document.getElementById("timer-display");
      const difficultyDisplay = document.getElementById("difficulty-display");
      const difficultyBtns = document.querySelectorAll(".difficulty-btn");
      const leaderboardDiv = document.getElementById("leaderboard");
      const gameCompletionPopup = document.getElementById(
        "game-completion-popup"
      );
      const completionTimeDisplay = document.getElementById("completion-time");
      const popupSaveScoreBtn = document.getElementById("popup-save-score");
      const popupPlayAgainBtn = document.getElementById("popup-play-again");
      const checkSolutionPopup = document.getElementById(
        "check-solution-popup"
      );
      const showSolutionYesBtn = document.getElementById("show-solution-yes");
      const showSolutionNoBtn = document.getElementById("show-solution-no");

      initializeBoard();
      generateNewGame();

      startGameBtn.addEventListener("click", () => {
        if (!gameStarted && startGameBtn.textContent === "Start Game") {
          startTimer();
          gameStarted = true;
          startGameBtn.textContent = "Restart Game";
          startGameBtn.disabled = true;
          difficultyDisplay.textContent =
            difficulty.charAt(0).toUpperCase() + difficulty.slice(1);
        } else {
          resetGame();
          generateNewGame();
          checkBtn.disabled = false;
        }
      });

      checkBtn.addEventListener("click", confirmCheckSolution);
      showLeaderboardBtn.addEventListener("click", toggleLeaderboard);

      popupSaveScoreBtn.addEventListener("click", () => {
        saveScore();
        popupSaveScoreBtn.textContent = "Score Saved!";
        popupSaveScoreBtn.disabled = true;
        setTimeout(() => {
          popupSaveScoreBtn.textContent = "Save Score";
        }, 2000);
      });

      popupPlayAgainBtn.addEventListener("click", () => {
        hideGameCompletionPopup();
        generateNewGame();
      });

      showSolutionYesBtn.addEventListener("click", () => {
        hideCheckSolutionPopup();
        showSolution();
      });

      showSolutionNoBtn.addEventListener("click", () => {
        hideCheckSolutionPopup();
      });

      difficultyBtns.forEach((btn) => {
        btn.addEventListener("click", (e) => {
          difficultyBtns.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          difficulty = btn.getAttribute("data-difficulty");
        });
      });

      function initializeBoard() {
        sudokuBoard.innerHTML = "";

        for (let row = 0; row < 9; row++) {
          for (let col = 0; col < 9; col++) {
            const cell = document.createElement("div");
            cell.className = "sudoku-cell";
            cell.setAttribute("data-row", row);
            cell.setAttribute("data-col", col);

            cell.addEventListener("click", () => {
              if (fixedCells[row][col]) return;

              if (selectedCell) {
                selectedCell.classList.remove("selected");
              }

              cell.classList.add("selected");
              selectedCell = cell;
            });

            sudokuBoard.appendChild(cell);
          }
        }

        document.addEventListener("keydown", (e) => {
          if (!selectedCell || !gameStarted) return;

          const row = parseInt(selectedCell.getAttribute("data-row"));
          const col = parseInt(selectedCell.getAttribute("data-col"));

          if (fixedCells[row][col]) return;

          if (e.key >= "1" && e.key <= "9") {
            const number = parseInt(e.key);
            board[row][col] = number;
            selectedCell.textContent = number;

            if (!isValidPlacement(row, col, number)) {
              selectedCell.classList.add("error");
            } else {
              selectedCell.classList.remove("error");
            }

            if (isBoardComplete()) {
              if (isSolutionCorrect()) {
                endGame(true);
              }
            }
          } else if (e.key === "Backspace" || e.key === "Delete") {
            board[row][col] = 0;
            selectedCell.textContent = "";
            selectedCell.classList.remove("error");
          }
        });
      }

      function generateNewGame() {
        resetGame();
        generateSolvedBoard();

        for (let row = 0; row < 9; row++) {
          for (let col = 0; col < 9; col++) {
            solution[row][col] = board[row][col];
          }
        }

        let cellsToRemove;
        switch (difficulty) {
          case "easy":
            cellsToRemove = 40;
            break;
          case "medium":
            cellsToRemove = 50;
            break;
          case "hard":
            cellsToRemove = 60;
            break;
          default:
            cellsToRemove = 40;
        }

        for (let i = 0; i < cellsToRemove; i++) {
          let row, col;
          do {
            row = Math.floor(Math.random() * 9);
            col = Math.floor(Math.random() * 9);
          } while (board[row][col] === 0);

          board[row][col] = 0;
        }

        for (let row = 0; row < 9; row++) {
          for (let col = 0; col < 9; col++) {
            fixedCells[row][col] = board[row][col] !== 0;
          }
        }

        updateBoardUI();
        startGameBtn.textContent = "Start Game";
        startGameBtn.disabled = false;
      }

      function generateSolvedBoard() {
        for (let row = 0; row < 9; row++) {
          for (let col = 0; col < 9; col++) {
            board[row][col] = 0;
          }
        }

        fillDiagonalBoxes();
        solveSudoku();
      }

      function fillDiagonalBoxes() {
        for (let box = 0; box < 3; box++) {
          fillBox(box * 3, box * 3);
        }
      }

      function fillBox(startRow, startCol) {
        let nums = [1, 2, 3, 4, 5, 6, 7, 8, 9];
        nums = shuffleArray(nums);
        let index = 0;
        for (let row = 0; row < 3; row++) {
          for (let col = 0; col < 3; col++) {
            board[startRow + row][startCol + col] = nums[index++];
          }
        }
      }

      function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }

      function solveSudoku() {
        for (let row = 0; row < 9; row++) {
          for (let col = 0; col < 9; col++) {
            if (board[row][col] !== 0) continue;

            for (let num = 1; num <= 9; num++) {
              if (isValidPlacement(row, col, num)) {
                board[row][col] = num;
                if (solveSudoku()) {
                  return true;
                }
                board[row][col] = 0;
              }
            }
            return false;
          }
        }
        return true;
      }

      function isValidPlacement(row, col, num) {
        for (let c = 0; c < 9; c++) {
          if (c !== col && board[row][c] === num) {
            return false;
          }
        }

        for (let r = 0; r < 9; r++) {
          if (r !== row && board[r][col] === num) {
            return false;
          }
        }

        const boxStartRow = Math.floor(row / 3) * 3;
        const boxStartCol = Math.floor(col / 3) * 3;

        for (let r = boxStartRow; r < boxStartRow + 3; r++) {
          for (let c = boxStartCol; c < boxStartCol + 3; c++) {
            if (r !== row || c !== col) {
              if (board[r][c] === num) {
                return false;
              }
            }
          }
        }

        return true;
      }

      function updateBoardUI() {
        const cells = document.querySelectorAll(".sudoku-cell");

        cells.forEach((cell) => {
          const row = parseInt(cell.getAttribute("data-row"));
          const col = parseInt(cell.getAttribute("data-col"));
          cell.textContent = "";
          cell.classList.remove("fixed");
          cell.classList.remove("selected");
          cell.classList.remove("error");

          if (board[row][col] !== 0) {
            cell.textContent = board[row][col];

            if (fixedCells[row][col]) {
              cell.classList.add("fixed");
            }
          }
        });

        selectedCell = null;
      }

      function startTimer() {
        if (timerInterval) {
          clearInterval(timerInterval);
        }
        timer = 0;
        timerDisplay.textContent = "00:00";

        timerInterval = setInterval(() => {
          timer++;
          const minutes = Math.floor(timer / 60)
            .toString()
            .padStart(2, "0");
          const seconds = (timer % 60).toString().padStart(2, "0");
          timerDisplay.textContent = `${minutes}:${seconds}`;
        }, 1000);
      }

      function resetGame() {
        for (let row = 0; row < 9; row++) {
          for (let col = 0; col < 9; col++) {
            board[row][col] = 0;
            solution[row][col] = 0;
            fixedCells[row][col] = false;
          }
        }

        updateBoardUI();

        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }

        timer = 0;
        timerDisplay.textContent = "00:00";
        gameStarted = false;
        gameWon = false;

        hideGameCompletionPopup();
        hideCheckSolutionPopup();

        checkBtn.disabled = false;
        startGameBtn.textContent = "Start Game";
        startGameBtn.disabled = false;
      }

      function isBoardComplete() {
        for (let row = 0; row < 9; row++) {
          for (let col = 0; col < 9; col++) {
            if (board[row][col] === 0) {
              return false;
            }
          }
        }
        return true;
      }

      function isSolutionCorrect() {
        for (let row = 0; row < 9; row++) {
          const rowValues = new Set();
          for (let col = 0; col < 9; col++) {
            if (rowValues.has(board[row][col])) {
              return false;
            }
            rowValues.add(board[row][col]);
          }
        }

        for (let col = 0; col < 9; col++) {
          const colValues = new Set();
          for (let row = 0; row < 9; row++) {
            if (colValues.has(board[row][col])) {
              return false;
            }
            colValues.add(board[row][col]);
          }
        }

        for (let boxRow = 0; boxRow < 3; boxRow++) {
          for (let boxCol = 0; boxCol < 3; boxCol++) {
            const boxValues = new Set();
            for (let row = boxRow * 3; row < boxRow * 3 + 3; row++) {
              for (let col = boxCol * 3; col < boxCol * 3 + 3; col++) {
                if (boxValues.has(board[row][col])) {
                  return false;
                }
                boxValues.add(board[row][col]);
              }
            }
          }
        }

        return true;
      }

      function checkSolution() {
        if (!gameStarted) return;

        if (!isBoardComplete()) {
          alert("The board is not complete yet!");
          return;
        }

        if (isSolutionCorrect()) {
          endGame(true);
        } else {
          alert("There are errors in your solution. Try again!");
        }
      }

      function confirmCheckSolution() {
        if (!gameStarted) return;

        showCheckSolutionPopup();
      }

      function showSolution() {
        clearInterval(timerInterval);
        gameStarted = false;

        for (let row = 0; row < 9; row++) {
          for (let col = 0; col < 9; col++) {
            board[row][col] = solution[row][col];
          }
        }

        updateBoardUI();
        startGameBtn.textContent = "Restart New Game";
        startGameBtn.disabled = false;
        checkBtn.disabled = true;
      }

      function endGame(won) {
        clearInterval(timerInterval);
        gameStarted = false;
        gameWon = won;

        if (won) {
          completionTimeDisplay.textContent = formatTime(timer);
          showGameCompletionPopup();
          checkBtn.disabled = true;
        }
      }

      function showGameCompletionPopup() {
        gameCompletionPopup.classList.add("active");
        popupSaveScoreBtn.disabled = false;
      }

      function hideGameCompletionPopup() {
        gameCompletionPopup.classList.remove("active");
      }

      function showCheckSolutionPopup() {
        checkSolutionPopup.classList.add("active");
      }

      function hideCheckSolutionPopup() {
        checkSolutionPopup.classList.remove("active");
      }

      function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${minutes}:${secs.toString().padStart(2, "0")}`;
      }

      function saveScore() {
        if (!gameWon) return;

        const currentUser = JSON.parse(localStorage.getItem("currentUser"));
        if (!currentUser) return;

        saveHighScore("sudoku", timer, true, { difficultyLevel: difficulty })
          .then((success) => {
            if (success) {
              console.log("Score saved successfully");
            } else {
              console.error("Failed to save score");
            }
          })
          .catch((error) => {
            console.error("Error saving score:", error);
          });
      }

      function toggleLeaderboard() {
        if (leaderboardDiv.style.display === "none") {
          leaderboardDiv.style.display = "block";
          showLeaderboardBtn.textContent = "Hide Leaderboard";
          fetchSudokuLeaderboard();
        } else {
          leaderboardDiv.style.display = "none";
          showLeaderboardBtn.textContent = "Show Leaderboard";
        }
      }

      async function fetchSudokuLeaderboard() {
        const leaderboardBody = document.getElementById("leaderboard-body");
        if (!leaderboardBody) return;

        leaderboardBody.innerHTML = "";

        try {
          const response = await fetch(
            `${window.API_URL}/sessions/leaderboard/sudoku`,
            {
              headers: {
                Authorization: `Bearer ${getAuthToken()}`,
              },
            }
          );

          if (!response.ok) {
            throw new Error("Failed to fetch leaderboard");
          }

          const leaderboardData = await response.json();

          if (leaderboardData.length === 0) {
            const emptyRow = document.createElement("tr");
            emptyRow.innerHTML = `<td colspan="4">No scores yet. Be the first to set a record!</td>`;
            leaderboardBody.appendChild(emptyRow);
            return;
          }

          const currentUser = JSON.parse(localStorage.getItem("currentUser"));

          leaderboardData.forEach((entry, index) => {
            const row = document.createElement("tr");

            row.innerHTML = `
              <td>${index + 1}</td>
              <td>${entry.Username}</td>
              <td>${formatTime(entry.Score)}</td>
              <td>${entry.Difficulty || "easy"}</td>
            `;

            if (currentUser && entry.Username === currentUser.username) {
              row.style.backgroundColor = "rgba(0, 255, 204, 0.1)";
            }

            leaderboardBody.appendChild(row);
          });
        } catch (error) {
          console.error("Error fetching sudoku leaderboard:", error);
          const errorRow = document.createElement("tr");
          errorRow.innerHTML = `<td colspan="4">Error loading leaderboard. Please try again later.</td>`;
          leaderboardBody.appendChild(errorRow);
        }
      }
    </script>
  </body>
</html>
